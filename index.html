<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Lady of Fatima Census</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Soft background */
        }
        .form-container {
            max-width: 900px;
            margin: 40px auto;
        }
        .conditional-fields {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0 1rem;
        }
        .conditional-fields.active {
            max-height: 500px; /* Large enough to cover content */
            opacity: 1;
            padding: 1rem;
            margin-top: 1rem;
        }
        /* Custom Field Styles */
        input[type="text"], input[type="date"], input[type="tel"], select {
            border: 1px solid #d1d5db;
            padding: 0.65rem 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input:focus, select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }
    </style>
</head>
<body>

    <div class="form-container bg-white shadow-2xl rounded-2xl p-6 md:p-12 border border-gray-200">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-[#1f2937] mb-2 font-serif tracking-tight">Our Lady of Fatima Census</h1>
            <p class="text-gray-500 text-lg">Detailed Household and Sacramental Registration</p>
        </header>
        
        <!-- ================================== -->
        <!-- THE MAIN FORM -->
        <!-- IMPORTANT: The Apps Script URL is now set -->
        <!-- ================================== -->
        <form id="censusForm" action="https://script.google.com/macros/s/AKfycbzBEaB_jnjRWFrLMwpMxrFnJMUjfuG39r4xWlwCI-NJ9oPzMB1jnoy4Jb5SL8Y70nMGSQ/exec" method="POST">
            
            <!-- HOUSEHOLD INFORMATION SECTION -->
            <div class="p-8 mb-10 rounded-xl bg-gray-50 border-l-4 border-indigo-700 shadow-lg">
                <h2 class="text-2xl font-bold text-indigo-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Household Information
                </h2>
                <p class="text-sm text-gray-600 mb-6">Enter the main household details below.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="BlockName" class="block text-sm font-medium text-gray-700">Block Name</label>
                        <input type="text" name="BlockName" id="BlockName" required class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="ResidentialAddress" class="block text-sm font-medium text-gray-700">Residential Address</label>
                        <input type="text" name="ResidentialAddress" id="ResidentialAddress" required class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="ContactNo" class="block text-sm font-medium text-gray-700">Contact Phone Number</label>
                        <input type="tel" name="ContactNo" id="ContactNo" required class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                </div>
            </div>

            <!-- ADULT MEMBERS INFORMATION SECTION -->
            <div class="p-8 mb-10 rounded-xl bg-gray-50 border-l-4 border-blue-700 shadow-lg">
                <h2 class="text-2xl font-bold text-blue-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20h-2m2 0h-2m0 0h-2m-3.112-2.357A3 3 0 0113 16h-3a3 3 0 01-2.888-2.357M6 12V7a4 4 0 014-4h4a4 4 0 014 4v5m-6 0h.01M16 19h-3a1 1 0 01-1-1v-4h4v4a1 1 0 01-1 1z"></path></svg>
                    Adult Members
                </h2>
                <div id="adult-members-container" class="space-y-8">
                    <!-- Dynamic Member Blocks Go Here -->
                </div>
                <button type="button" id="add-member-button" onclick="addMember()" class="mt-8 w-full text-center bg-blue-700 text-white py-3 rounded-lg font-semibold hover:bg-blue-800 transition duration-150 shadow-md">
                    + Add Another Adult Member
                </button>
            </div>

            <!-- CHILDREN INFORMATION SECTION -->
            <div class="p-8 mb-10 rounded-xl bg-gray-50 border-l-4 border-emerald-600 shadow-lg">
                <h2 class="text-2xl font-bold text-emerald-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Children
                </h2>
                <div id="children-container" class="space-y-8">
                    <!-- Dynamic Child Blocks Go Here -->
                </div>
                <button type="button" id="add-child-button" onclick="addChild()" class="mt-8 w-full text-center bg-emerald-600 text-white py-3 rounded-lg font-semibold hover:bg-emerald-700 transition duration-150 shadow-md">
                    + Add Another Child
                </button>
            </div>

            <!-- SUBMIT BUTTON -->
            <div id="form-feedback" class="mb-4 text-center hidden text-lg font-medium"></div>
            <button type="submit" id="submit-button" class="w-full bg-indigo-700 text-white py-4 rounded-lg text-xl font-bold hover:bg-indigo-800 transition duration-200 shadow-xl tracking-wide">
                Submit Household Census
            </button>
            
        </form>
    </div>

    <script>
        // --- Global Counters ---
        let memberIndex = 0; 
        let childIndex = 0;

        // --- Helper Function for Conditional Field Toggling (Baptism, Communion, Confirmation, Dikabelo) ---
        function toggleConditionalFields(selectElement) {
            const block = selectElement.closest('.member-block') || selectElement.closest('.child-block');
            // Extracts field name from "members[i][FieldName]" or "children[i][FieldName]"
            const fieldNameMatch = selectElement.name.match(/\[(\w+)\]$/);
            const fieldName = fieldNameMatch ? fieldNameMatch[1] : null; 

            // Find the specific container for the conditional fields
            const conditionalContainer = block.querySelector(`[data-conditional-for="${fieldName}"]`);

            if (conditionalContainer) {
                if (selectElement.value === 'Yes') {
                    conditionalContainer.classList.add('active');
                } else {
                    conditionalContainer.classList.remove('active');
                }
            }
        }

        // --- Helper Function for Marital Status Fields (Conditional on Married/Widower) ---
        function toggleMaritalFields(selectElement) {
            const block = selectElement.closest('.member-block');
            const conditionalContainer = block.querySelector('[data-conditional-for="MaritalStatus"]');
            
            if (selectElement.value === 'Married' || selectElement.value === 'Widower') {
                conditionalContainer.classList.add('active');
            } else {
                conditionalContainer.classList.remove('active');
            }
        }

        // --- Template Functions ---

        function createMemberBlock(index) {
            const block = document.createElement('div');
            block.className = 'member-block p-6 border border-blue-300 rounded-lg bg-white shadow-lg relative';
            block.id = `member-${index}`;
            block.innerHTML = `
                <h3 class="text-xl font-semibold text-blue-700 mb-6 border-b pb-2">Adult Member ${index + 1}</h3>
                
                <button type="button" onclick="removeBlock('member-${index}')" class="absolute top-6 right-6 text-red-500 hover:text-red-700 text-sm font-medium ${index === 0 ? 'hidden' : ''} bg-gray-100 p-2 rounded-lg shadow-sm">Remove</button>
                
                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <label class="block">First Name: <input type="text" name="members[${index}][FirstName]" ${index === 0 ? 'required' : ''} class="mt-1 block w-full"></label>
                    <label class="block">Last Name: <input type="text" name="members[${index}][LastName]" ${index === 0 ? 'required' : ''} class="mt-1 block w-full"></label>
                    <label class="block">Date of Birth: <input type="date" name="members[${index}][DOB]" class="mt-1 block w-full"></label>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <label class="block">Catholic?: 
                        <select name="members[${index}][Catholic]" class="mt-1 block w-full">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </label>
                    <label class="block">Occupation: <input type="text" name="members[${index}][Occupation]" class="mt-1 block w-full"></label>
                    <label class="block">Church Activities: <input type="text" name="members[${index}][ChurchActivities]" class="mt-1 block w-full"></label>
                    <label class="block">Solidarity/Ministry: <input type="text" name="members[${index}][SolidarityMinistry]" class="mt-1 block w-full"></label>
                </div>
                
                <label class="block mb-8">Leadership Role: <input type="text" name="members[${index}][Leadership]" class="mt-1 block w-full"></label>

                <div class="border-t pt-6 space-y-6">
                    
                    <!-- BAPTISM SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-blue-50 border-l-4 border-blue-400">
                        <h4 class="text-blue-700 font-bold mb-3">Baptism Sacrament</h4>
                        <label class="block mb-4">Baptised? (Yes/No): 
                            <select name="members[${index}][Baptised]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-blue-200" data-conditional-for="Baptised">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Date of Baptism: <input type="date" name="members[${index}][BaptismDate]" class="mt-1 block w-full"></label>
                                <label class="block">Registration Number: <input type="text" name="members[${index}][RegistrationNumber]" class="mt-1 block w-full"></label>
                                <label class="block">Church of Baptism: <input type="text" name="members[${index}][ChurchOfBaptism]" class="mt-1 block w-full"></label>
                                <label class="block">Location of Church: <input type="text" name="members[${index}][LocationOfChurch]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                    </div>

                    <!-- 1ST COMMUNION SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-blue-50 border-l-4 border-blue-400">
                        <h4 class="text-blue-700 font-bold mb-3">First Communion Sacrament</h4>
                        <label class="block mb-4">1st Communion? (Yes/No): 
                            <select name="members[${index}][FirstCommunion]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-blue-200" data-conditional-for="FirstCommunion">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Date 1st Communion: <input type="date" name="members[${index}][FirstCommunionDate]" class="mt-1 block w-full"></label>
                                <label class="block">Church of 1st Communion: <input type="text" name="members[${index}][ChurchOfFirstCommunion]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                    </div>

                    <!-- CONFIRMATION SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-blue-50 border-l-4 border-blue-400">
                        <h4 class="text-blue-700 font-bold mb-3">Confirmation Sacrament</h4>
                        <label class="block mb-4">Confirmed? (Yes/No): 
                            <select name="members[${index}][Confirmation]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-blue-200" data-conditional-for="Confirmation">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Date of Confirmation: <input type="date" name="members[${index}][ConfirmationDate]" class="mt-1 block w-full"></label>
                                <label class="block">Church of Confirmation: <input type="text" name="members[${index}][ChurchOfConfirmation]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                    </div>

                    <!-- MARITAL STATUS SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-blue-50 border-l-4 border-blue-400">
                        <h4 class="text-blue-700 font-bold mb-3">Marital Status & Matrimony Details</h4>
                        <label class="block mb-4">Marital Status: 
                            <select name="members[${index}][MaritalStatus]" onchange="toggleMaritalFields(this)" class="mt-1 block w-full">
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Widower">Widow(er)</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-blue-200" data-conditional-for="MaritalStatus">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Civil Court Marriage Date (Optional): <input type="date" name="members[${index}][CivilCourtMarriageDate]" class="mt-1 block w-full"></label>
                                <label class="block">Church Marriage Date (Optional): <input type="date" name="members[${index}][ChurchMarriageDate]" class="mt-1 block w-full"></label>
                                <label class="block md:col-span-2">Church Marriage Place (Optional): <input type="text" name="members[${index}][ChurchMarriagePlace]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                        <label class="block mt-4">Divorced? (Yes/No option): 
                            <select name="members[${index}][Divorced]" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                    </div>

                    <!-- DIKABELO SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-blue-50 border-l-4 border-blue-400">
                        <h4 class="text-blue-700 font-bold mb-3">Dikabelo</h4>
                        <label class="block mb-4">Dikabelo? (Yes/No option): 
                            <select name="members[${index}][Dikabelo]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-blue-200" data-conditional-for="Dikabelo">
                            <label class="block">Date of Last Dikabelo: <input type="date" name="members[${index}][DateOfLastDikabelo]" class="mt-1 block w-full"></label>
                        </div>
                    </div>
                </div>
            `;
            return block;
        }

        function createChildBlock(index) {
             const block = document.createElement('div');
             block.className = 'child-block p-6 border border-emerald-300 rounded-lg bg-white shadow-lg relative';
             block.id = `child-${index}`;
             block.innerHTML = `
                <h3 class="text-xl font-semibold text-emerald-700 mb-6 border-b pb-2">Child ${index + 1}</h3>
                
                <button type="button" onclick="removeBlock('child-${index}')" class="absolute top-6 right-6 text-red-500 hover:text-red-700 text-sm font-medium bg-gray-100 p-2 rounded-lg shadow-sm">Remove</button>
                
                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <label class="block">First Name: <input type="text" name="children[${index}][FirstName]" class="mt-1 block w-full"></label>
                    <label class="block">Last Name: <input type="text" name="children[${index}][LastName]" class="mt-1 block w-full"></label>
                    <label class="block">Date of Birth: <input type="date" name="children[${index}][DOB]" onchange="calculateAge(this, 'children[${index}][Age]')" class="mt-1 block w-full"></label>
                    <label class="block">Age: <input type="text" name="children[${index}][Age]" readonly class="mt-1 block w-full bg-gray-100 cursor-default"></label>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <label class="block">Catholic? (Yes/No option): 
                        <select name="children[${index}][Catholic]" class="mt-1 block w-full">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </label>
                    <label class="block md:col-span-2">Church Activities: <input type="text" name="children[${index}][ChurchActivities]" class="mt-1 block w-full"></label>
                </div>

                <div class="border-t pt-6 space-y-6">
                    
                    <!-- BAPTISM SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-emerald-50 border-l-4 border-emerald-400">
                        <h4 class="text-emerald-700 font-bold mb-3">Baptism Sacrament</h4>
                        <label class="block mb-4">Baptised? (Yes/No option): 
                            <select name="children[${index}][Baptised]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-emerald-200" data-conditional-for="Baptised">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Date of Baptism: <input type="date" name="children[${index}][BaptismDate]" class="mt-1 block w-full"></label>
                                <label class="block">Registration Number: <input type="text" name="children[${index}][RegistrationNumber]" class="mt-1 block w-full"></label>
                                <label class="block">Church of Baptism: <input type="text" name="children[${index}][ChurchOfBaptism]" class="mt-1 block w-full"></label>
                                <label class="block">Location of Church: <input type="text" name="children[${index}][LocationOfChurch]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                    </div>

                    <!-- 1ST COMMUNION SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-emerald-50 border-l-4 border-emerald-400">
                        <h4 class="text-emerald-700 font-bold mb-3">First Communion Sacrament</h4>
                        <label class="block mb-4">1st Communion? (Yes/No option): 
                            <select name="children[${index}][FirstCommunion]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-emerald-200" data-conditional-for="FirstCommunion">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Date 1st Communion: <input type="date" name="children[${index}][FirstCommunionDate]" class="mt-1 block w-full"></label>
                                <label class="block">Church of 1st Communion: <input type="text" name="children[${index}][ChurchOfFirstCommunion]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                    </div>

                    <!-- CONFIRMATION SUB-SECTION -->
                    <div class="p-4 rounded-lg bg-emerald-50 border-l-4 border-emerald-400">
                        <h4 class="text-emerald-700 font-bold mb-3">Confirmation Sacrament</h4>
                        <label class="block mb-4">Confirmed? (Yes/No option): 
                            <select name="children[${index}][Confirmation]" onchange="toggleConditionalFields(this)" class="mt-1 block w-full">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </label>
                        <div class="conditional-fields bg-white p-4 rounded-lg border border-emerald-200" data-conditional-for="Confirmation">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Date of Confirmation: <input type="date" name="children[${index}][ConfirmationDate]" class="mt-1 block w-full"></label>
                                <label class="block">Church of Confirmation: <input type="text" name="children[${index}][ChurchOfConfirmation]" class="mt-1 block w-full"></label>
                            </div>
                        </div>
                    </div>
                </div>
             `;
             return block;
        }
        
        // Function to calculate age based on DOB
        function calculateAge(dobInput, ageFieldName) {
            const dob = new Date(dobInput.value);
            const now = new Date();
            let age = now.getFullYear() - dob.getFullYear();
            const monthDiff = now.getMonth() - dob.getMonth();
            
            // Adjust age if current month/day is before birth month/day
            if (monthDiff < 0 || (monthDiff === 0 && now.getDate() < dob.getDate())) {
                age--;
            }

            // Find the age input using the full name attribute
            const form = dobInput.closest('form');
            const ageInput = form.querySelector(`input[name="${ageFieldName}"]`);
            if (ageInput) {
                ageInput.value = age >= 0 ? age : '';
            }
        }


        // --- Dynamic Field Manager ---

        function addMember() {
            const container = document.getElementById('adult-members-container');
            const newBlock = createMemberBlock(memberIndex);
            
            // Add the new member block
            container.appendChild(newBlock); 
            memberIndex++; 
        }
        
        function addChild() {
            const container = document.getElementById('children-container');
            const newBlock = createChildBlock(childIndex);
            
            // Add the new child block
            container.appendChild(newBlock);
            childIndex++; 
        }
        
        function removeBlock(id) {
            document.getElementById(id).remove();
            // The JSON extraction logic skips removed/empty blocks, so no re-indexing is needed.
        }

        // --- Data Extraction and Submission Logic (JSON) ---

        /**
         * Gathers all form data into a structured JSON object.
         */
        function getFormDataAsJson(form) {
            const data = {
                BlockName: form.BlockName.value,
                ResidentialAddress: form.ResidentialAddress.value,
                ContactNo: form.ContactNo.value,
                members: [],
                children: []
            };

            // Helper to extract fields from a block
            const extractFields = (block, prefix) => {
                const fields = {};
                const inputs = block.querySelectorAll('input, select');
                inputs.forEach(input => {
                    const name = input.name;
                    // Check if the name starts with the required prefix, e.g., 'members[0][' or 'children[1]['
                    if (name && name.startsWith(prefix)) {
                        const fieldKey = name.match(/\[(\w+)\]$/)[1]; // Extract the field name (e.g., 'FirstName')
                        fields[fieldKey] = input.value;
                    }
                });
                return fields;
            };

            // Extract Adult Members
            document.querySelectorAll('.member-block').forEach((block, index) => {
                const member = extractFields(block, `members[${index}]`);
                // Only include members that have a first name filled out (to ignore removed/empty blocks)
                if (member.FirstName) {
                    data.members.push(member);
                }
            });

            // Extract Children
            document.querySelectorAll('.child-block').forEach((block, index) => {
                const child = extractFields(block, `children[${index}]`);
                // Only include children that have a first name filled out
                if (child.FirstName) {
                    data.children.push(child);
                }
            });

            return data;
        }

        document.getElementById('censusForm').addEventListener('submit', function(event) {
            event.preventDefault(); 
            
            const form = event.target;
            const feedback = document.getElementById('form-feedback');
            const submitButton = document.getElementById('submit-button');
            const appsScriptUrl = form.action;

            const payload = getFormDataAsJson(form);

            // Basic validation
            if (!payload.BlockName || !payload.ResidentialAddress || !payload.ContactNo) {
                feedback.textContent = '❌ Please fill out all Household Information fields.';
                feedback.className = 'mb-4 text-center text-red-600 text-lg font-bold block';
                return;
            }
            if (payload.members.length === 0) {
                 feedback.textContent = '❌ Please add at least one Adult Member.';
                feedback.className = 'mb-4 text-center text-red-600 text-lg font-bold block';
                return;
            }
            
            feedback.textContent = 'Submitting... Please wait.';
            feedback.className = 'mb-4 text-center text-blue-600 text-lg font-medium block';
            submitButton.disabled = true;

            
            // Set up retry logic for robust submission
            const maxRetries = 3;
            let currentRetry = 0;
            
            const attemptSubmit = () => {
                fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // IMPORTANT: Using JSON
                    },
                    body: JSON.stringify(payload), // Send the JSON string
                })
                .then(response => {
                    // Apps Script returns 'Success' or an error message as plain text
                    return response.text(); 
                })
                .then(result => {
                    if (result.trim() === 'Success') {
                        feedback.textContent = '✅ Submission successful! Thank you for completing the census.';
                        feedback.className = 'mb-4 text-center text-green-600 text-lg font-bold block';
                        form.reset(); 
                        // Re-initialize dynamic fields after reset
                        document.getElementById('adult-members-container').innerHTML = '';
                        document.getElementById('children-container').innerHTML = '';
                        memberIndex = 0;
                        childIndex = 0;
                        addMember(); // Re-add the first required member
                    } else {
                        // Handle error message returned by Apps Script
                        throw new Error("API returned failure: " + result);
                    }
                })
                .catch(error => {
                    console.error('Submission Error:', error);
                    if (currentRetry < maxRetries) {
                        currentRetry++;
                        const delay = Math.pow(2, currentRetry) * 1000; // Exponential backoff
                        feedback.textContent = `Submission failed. Retrying in ${delay / 1000}s... (Attempt ${currentRetry}/${maxRetries})`;
                        setTimeout(attemptSubmit, delay);
                    } else {
                        feedback.textContent = '❌ Submission failed after multiple attempts. Check console for details.';
                        feedback.className = 'mb-4 text-center text-red-600 text-lg font-bold block';
                    }
                })
                .finally(() => {
                    if (currentRetry >= maxRetries || feedback.textContent.includes('successful')) {
                        submitButton.disabled = false;
                    }
                });
            };

            attemptSubmit();
        });

        // --- Initialization ---
        window.onload = function() {
            // Start the form with the main adult member (Member 1)
            addMember();
        };

    </script>
</body>
</html>
